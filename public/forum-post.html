<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¾åº¦è´´å§ - å¸–å­è¯¦æƒ…</title>
    <!-- å¼•å…¥PCæ ·å¼ -->
    <link rel="stylesheet" href="forum-post.css">
    <!-- å¼•å…¥å“åº”å¼ï¼ˆæ‰‹æœº/å¹³æ¿ï¼‰æ ·å¼ -->
    <link rel="stylesheet" href="forum-post-responsive.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="header-content">
            <a href="forum-index.html" class="back-btn">â† è¿”å›åˆ—è¡¨</a>
            <h1>ğŸ“– å¸–å­è¯¦æƒ…</h1>
            <button id="themeToggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
        </div>
    </header>
    
    <!-- ç®¡ç†å‘˜åˆ é™¤æŒ‰é’® - é»˜è®¤éšè—ï¼ŒåŒå‡»æ˜¾ç¤º -->
    <div id="adminDeleteBtn" style="display: none; position: fixed; bottom: 20px; left: 20px; z-index: 9999;">
        <button onclick="deletePost()" style="background: #ff4757; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
            ğŸ—‘ï¸ åˆ é™¤å¸–å­
        </button>
    </div>
    
    <div class="container">
        <!-- å¸–å­è¯¦æƒ… -->
        <div class="post-detail">
            <div id="postDetailContainer">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- è¯„è®ºåŒº -->
        <div class="comments-section">
            <div class="comments-header">ğŸ’¬ è¯„è®ºåŒº</div>
            
            <!-- è¯„è®ºåˆ—è¡¨ -->
            <div class="comment-list">
                <div class="comment-count">è¯„è®º (0)</div>
                <div id="commentsContainer">åŠ è½½è¯„è®ºä¸­...</div>
            </div>
            
            <!-- è¯„è®ºè¡¨å• -->
            <div class="comment-form">
                <div class="form-group">
                    <label>æ˜µç§° *</label>
                    <input type="text" id="commentNick" placeholder="æ‚¨çš„æ˜µç§°" required>
                </div>
                <div class="form-group">
                    <label>è¯„è®ºå†…å®¹ *</label>
                    <textarea id="commentContent" placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..." required></textarea>
                </div>
                <button class="submit-btn" onclick="submitComment()">å‘è¡¨è¯„è®º</button>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = 'https://bbs.whmx.top';
        
        // è·å–URLå‚æ•°
        function getUrlParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        const postId = getUrlParam('id');
        
        // è·å–åˆ†ç±»ä¸­æ–‡åç§°
        function getCategoryName(category) {
            const categoryMap = {
                'tech': 'æŠ€æœ¯',
                'life': 'ç”Ÿæ´»',
                'entertainment': 'å¨±ä¹',
                'education': 'æ•™è‚²',
                'other': 'å…¶ä»–'
            };
            return categoryMap[category] || 'å…¶ä»–';
        }
        
        // åŠ è½½å¸–å­è¯¦æƒ…å’Œè¯„è®º
        async function loadPostDetail() {
            if (!postId) {
                document.getElementById('postDetailContainer').innerHTML = 
                    '<p style="color: var(--accent-color); padding: 20px; text-align: center;">å¸–å­IDæ— æ•ˆ</p>';
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/posts/' + postId);
                const result = await response.json();
                
                if (result.errno === 0) {
                    await displayPostDetail(result.data.post);
                    displayComments(result.data.comments);
                } else {
                    document.getElementById('postDetailContainer').innerHTML = 
                        '<p style="color: var(--accent-color); padding: 20px; text-align: center;">åŠ è½½å¸–å­å¤±è´¥: ' + result.errmsg + '</p>';
                }
            } catch (error) {
                document.getElementById('postDetailContainer').innerHTML = 
                    '<p style="color: var(--accent-color); padding: 20px; text-align: center;">ç½‘ç»œé”™è¯¯: ' + error.message + '</p>';
            }
        }
        
        let currentPost = null;
        
        // æ˜¾ç¤ºå¸–å­è¯¦æƒ…
        async function displayPostDetail(post) {
            currentPost = post;
            const container = document.getElementById('postDetailContainer');
            const time = new Date(post.created).toLocaleString();
            const categoryName = getCategoryName(post.category || 'other');
            
            let html = '';
            
            // å¸–å­å¤´éƒ¨ä¿¡æ¯
            html += '<div class="post-header">';
            html += '<div class="post-title">' + post.title + '</div>';
            html += '<div class="post-meta">';
            html += '<span class="category-badge">' + categoryName + '</span>';
            html += '<span>ä½œè€…: ' + post.author + '</span>';
            html += '<span>å‘å¸ƒæ—¶é—´: ' + time + '</span>';
            html += '<span>æµè§ˆ: ' + (post.view_count || 0) + '</span>';
            html += '<span>è¯„è®º: ' + (post.comment_count || 0) + '</span>';
            html += '<span>ç‚¹èµ: ' + (post.like_count || 0) + '</span>';
            html += '</div>';
            html += '</div>';
            
            // å¸–å­å†…å®¹
            html += '<div class="post-content">';
            
            // å°†å†…å®¹æŒ‰æ¢è¡Œç¬¦åˆ†å‰²æˆæ®µè½
            const paragraphs = post.content.split(/\r?\n/);
            paragraphs.forEach(para => {
                if (para.trim()) {
                    html += '<p>' + para + '</p>';
                }
            });
            
            // å›¾ç‰‡å±•ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
            if (post.images && post.images.length > 0) {
                html += '<div class="post-images">';
                post.images.forEach((image, index) => {
                    // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯çœŸå®çš„å›¾ç‰‡URL
                    // ç°åœ¨ä½¿ç”¨å ä½å›¾æ¨¡æ‹Ÿ
                    const imgSrc = image.includes('data:image') ? 
                        image : `https://picsum.photos/id/${index + 100}/400/300`;
                    html += '<img src="' + imgSrc + '" class="post-image" alt="å¸–å­å›¾ç‰‡ ' + (index + 1) + '">';
                });
                html += '</div>';
            }
            
            html += '</div>';
            
            // å¸–å­æ“ä½œæ 
            html += '<div class="post-actions">';
            html += '<button class="action-btn" onclick="likePost()">ğŸ‘ ç‚¹èµ (' + (post.like_count || 0) + ')</button>';
            html += '<button class="action-btn" onclick="sharePost()">ğŸ“¤ åˆ†äº«</button>';
            html += '</div>';
            
            container.innerHTML = html;
            
            // è·å–å¹¶æ›´æ–°ç‚¹èµçŠ¶æ€
            try {
                const statusResponse = await fetch(API_BASE + '/posts/' + postId + '/like');
                const statusResult = await statusResponse.json();
                
                if (statusResult.errno === 0) {
                    const { like_count, user_liked } = statusResult.data;
                    
                    // æ›´æ–°å½“å‰å¸–å­çš„ç‚¹èµæ•°
                    if (currentPost) {
                        currentPost.like_count = like_count;
                    }
                    
                    // æ›´æ–°ç‚¹èµæŒ‰é’®æ˜¾ç¤º
                    const likeBtn = document.querySelector('.action-btn:first-child');
                    if (likeBtn) {
                        likeBtn.textContent = `${user_liked ? 'ğŸ‘ å·²ç‚¹èµ' : 'ğŸ‘ ç‚¹èµ'} (${like_count})`;
                        // æ·»åŠ ç‚¹èµçŠ¶æ€æ ·å¼
                        if (user_liked) {
                            likeBtn.classList.add('liked');
                        }
                    }
                }
            } catch (error) {
                console.error('è·å–ç‚¹èµçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºè¯„è®º
        function displayComments(comments) {
            const container = document.getElementById('commentsContainer');
            const countElement = document.querySelector('.comment-count');
            
            // æ›´æ–°è¯„è®ºæ•°é‡
            countElement.textContent = `è¯„è®º (${comments && comments.length ? comments.length : 0})`;
            
            // åŒæ­¥æ›´æ–°åˆ—è¡¨é¡µçš„è¯„è®ºå’Œç‚¹èµæ•°é‡
            if (window.opener && window.opener.updatePostCounts) {
                window.opener.updatePostCounts(postId, comments.length, currentPost?.like_count || 0);
            }
            
            if (!comments || comments.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px 0;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥è¸Šè·ƒå‘è¨€å§ï¼</p>';
                return;
            }
            
            // æŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åºï¼Œè®©æœ€æ–°è¯„è®ºæ˜¾ç¤ºåœ¨é¡¶éƒ¨
            const sortedComments = [...comments].sort((a, b) => b.created - a.created);
            
            let html = '';
            sortedComments.forEach(comment => {
                const time = new Date(comment.created).toLocaleString();
                html += '<div class="comment-item">';
                html += '<div class="comment-header">';
                html += '<span class="comment-author">' + comment.nick + '</span>';
                html += '<span class="comment-time">' + time + '</span>';
                html += '</div>';
                html += '<div class="comment-content">' + comment.comment + '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        // æäº¤è¯„è®º
        async function submitComment() {
            const nick = document.getElementById('commentNick').value;
            const content = document.getElementById('commentContent').value;
            
            if (!nick || !content) {
                alert('è¯·å¡«å†™æ˜µç§°å’Œè¯„è®ºå†…å®¹');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/posts/' + postId + '/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        comment: content,
                        nick: nick,
                        mail: '',
                        link: ''
                    })
                });
                
                const result = await response.json();
                if (result.errno === 0) {
                    alert('è¯„è®ºå‘è¡¨æˆåŠŸï¼');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('commentNick').value = '';
                    document.getElementById('commentContent').value = '';
                    // é‡æ–°åŠ è½½è¯„è®º
                    loadPostDetail();
                } else {
                    alert('è¯„è®ºå¤±è´¥: ' + result.errmsg);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        // å¸–å­ç‚¹èµåŠŸèƒ½
        async function likePost() {
            try {
                const response = await fetch(API_BASE + '/posts/' + postId + '/like', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                if (result.errno === 0) {
                    // è·å–æœ€æ–°çš„ç‚¹èµçŠ¶æ€å’Œæ•°é‡
                    const statusResponse = await fetch(API_BASE + '/posts/' + postId + '/like');
                    const statusResult = await statusResponse.json();
                    
                    if (statusResult.errno === 0) {
                        const { like_count, user_liked } = statusResult.data;
                        
                        // æ›´æ–°å½“å‰å¸–å­çš„ç‚¹èµæ•°
                        if (currentPost) {
                            currentPost.like_count = like_count;
                        }
                        
                        // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                        const likeBtn = document.querySelector('.action-btn:first-child');
                        if (likeBtn) {
                            likeBtn.textContent = `${user_liked ? 'ğŸ‘ å·²ç‚¹èµ' : 'ğŸ‘ ç‚¹èµ'} (${like_count})`;
                            // æ·»åŠ ç‚¹èµçŠ¶æ€æ ·å¼
                            if (user_liked) {
                                likeBtn.classList.add('liked');
                            } else {
                                likeBtn.classList.remove('liked');
                            }
                        }
                        
                        // åŒæ­¥æ›´æ–°åˆ—è¡¨é¡µçš„ç‚¹èµæ•°é‡
                        if (window.opener && window.opener.updatePostCounts) {
                            const commentCount = document.querySelectorAll('.comment-item').length;
                            window.opener.updatePostCounts(postId, commentCount, like_count);
                        }
                        
                        alert(user_liked ? 'ç‚¹èµæˆåŠŸï¼' : 'å·²å–æ¶ˆç‚¹èµï¼');
                    }
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + result.errmsg);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
            }
        }
        
        function sharePost() {
            const currentUrl = window.location.href;
            navigator.clipboard.writeText(currentUrl).then(() => {
                alert('é“¾æ¥å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + currentUrl);
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }
        
        // åˆ é™¤å¸–å­åŠŸèƒ½
        async function deletePost() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸–å­å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            // æç¤ºè¾“å…¥ç®¡ç†å‘˜å¯†ç 
            const adminKey = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :');
            if (!adminKey) {
                alert('å¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/posts/' + postId, {
                    method: 'DELETE',
                    headers: {
                        'X-Admin-Key': adminKey
                    }
                });
                
                const result = await response.json();
                if (result.errno === 0) {
                    alert('å¸–å­åˆ é™¤æˆåŠŸï¼');
                    // é‡å®šå‘åˆ°å¸–å­åˆ—è¡¨é¡µé¢
                    window.location.href = 'forum-index.html';
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.errmsg);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
    function setupThemeToggle() {
        const themeToggle = document.getElementById('themeToggle');
        
        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸»é¢˜åå¥½ - é»˜è®¤ä½¿ç”¨æµ…è‰²æ¨¡å¼
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = 'ğŸŒ™';
        } else {
            themeToggle.textContent = 'â˜€ï¸';
        }
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'ğŸŒ™';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'â˜€ï¸';
            }
        });
    }
        
        // å®ç°åŒå‡»æ˜¾ç¤º/éšè—åˆ é™¤æŒ‰é’®
        let deleteBtnTimeout;
        
        document.addEventListener('dblclick', function(event) {
            // é¿å…ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘
            if (event.target.id === 'adminDeleteBtn' || event.target.parentElement?.id === 'adminDeleteBtn') {
                return;
            }
            
            const deleteBtn = document.getElementById('adminDeleteBtn');
            const isVisible = deleteBtn.style.display !== 'none';
            deleteBtn.style.display = isVisible ? 'none' : 'block';
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (deleteBtnTimeout) clearTimeout(deleteBtnTimeout);
            
            // å¦‚æœæ˜¾ç¤ºäº†æŒ‰é’®ï¼Œ30ç§’åè‡ªåŠ¨éšè—
            if (!isVisible) {
                deleteBtnTimeout = setTimeout(() => {
                    deleteBtn.style.display = 'none';
                }, 30000);
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            setupThemeToggle();
            loadPostDetail();
        });
    </script>
</body>
</html>



