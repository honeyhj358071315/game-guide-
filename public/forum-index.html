<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¾åº¦è´´å§ - å¸–å­åˆ—è¡¨</title>
    <!-- å¼•å…¥PCæ ·å¼ -->
    <link rel="stylesheet" href="forum-index.css">
    <!-- å¼•å…¥å“åº”å¼ï¼ˆæ‰‹æœº/å¹³æ¿ï¼‰æ ·å¼ -->
    <link rel="stylesheet" href="forum-index-responsive.css">
</head>

<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="header">
            <div class="header-content">
                <h1>ğŸ¦„æ›²è§£å™¨è€…-ç»¼åˆè®¨è®ºåŒº</h1>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="header-nav">
                        <a href="/index.html">é¦–é¡µ</a>
                        <a href="#">å…³æ³¨</a>
                        <a href="#">æ’è¡Œæ¦œ</a>
                    </div>
                    <button id="themeToggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                </div>
            </div>
        </header>

        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <span>æ¬¢è¿æ¥åˆ°å’•ç‰©å§ï¼</span>
            <button class="create-post-btn" onclick="showCreatePostModal()">ğŸ“ å‘è¡¨æ–°å¸–</button>
        </div>

        <!-- åˆ†ç±»ç­›é€‰ -->
        <div class="category-filter">
            <div class="category-tabs">
                <div class="category-tab active" onclick="filterByCategory('all')">å…¨éƒ¨</div>
                <div class="category-tab" onclick="filterByCategory('tech')">ç²¾å</div>
                <div class="category-tab" onclick="filterByCategory('life')">æ”¶è—</div>
                <div class="category-tab" onclick="filterByCategory('entertainment')">çŒæ°´</div>
                <div class="category-tab" onclick="filterByCategory('education')">æ”»ç•¥</div>
                <div class="category-tab" onclick="filterByCategory('other')">å…¶ä»–</div>
            </div>
        </div>

        <!-- å¸–å­åˆ—è¡¨ -->
        <div class="posts-section">
            <div class="posts-header">
                <span>æœ€æ–°å¸–å­</span>
                <span class="post-count">å…± <span id="totalPosts">0</span> ä¸ªå¸–å­</span>
            </div>
            <div id="postsContainer">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- åˆ›å»ºå¸–å­æ¨¡æ€æ¡† -->
    <div id="createPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å‘è¡¨æ–°å¸–å­</h3>
            </div>
            <div class="form-group">
                <label>å¸–å­æ ‡é¢˜ *</label>
                <input type="text" id="postTitle" placeholder="è¯·è¾“å…¥å¸–å­æ ‡é¢˜" required>
            </div>
            <div class="form-group">
                <label>å¸–å­åˆ†ç±» *</label>
                <select id="postCategory" required>
                    <option value="tech">ç²¾å</option>
                    <option value="life">æ”¶è—</option>
                    <option value="entertainment">çŒæ°´</option>
                    <option value="education">æ”»ç•¥</option>
                    <option value="other">å…¶ä»–</option>
                </select>
            </div>
            <div class="form-group">
                <label>å¸–å­å†…å®¹ *</label>
                <textarea id="postContent" placeholder="è¯·è¾“å…¥å¸–å­å†…å®¹..." required></textarea>
            </div>
            <div class="form-group">
                <label>ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                <input type="file" id="postImages" multiple accept="image/*">
                <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">æ”¯æŒä¸Šä¼ å¤šå¼ å›¾ç‰‡ï¼Œå•å¼ ä¸è¶…è¿‡5MB</p>
                <div id="imagePreview" style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;"></div>
            </div>
            <div class="form-group">
                <label>ä½œè€…æ˜µç§° *</label>
                <input type="text" id="postAuthor" placeholder="æ‚¨çš„æ˜µç§°" required>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="hideCreatePostModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createPost()">å‘è¡¨</button>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = 'https://bbs.whmx.top';
        let allPosts = [];
        let currentCategory = 'all';

        // åŠ è½½å¸–å­åˆ—è¡¨
        async function loadPosts() {
            try {
                const response = await fetch(API_BASE + '/posts');
                const result = await response.json();
                if (result.errno === 0) {
                    allPosts = result.data || [];
                    document.getElementById('totalPosts').textContent = allPosts.length;
                    filterByCategory(currentCategory);
                } else {
                    document.getElementById('postsContainer').innerHTML =
                        '<p style="color: var(--accent-color);">åŠ è½½å¸–å­å¤±è´¥</p>';
                }
            } catch (error) {
                document.getElementById('postsContainer').innerHTML =
                    '<p style="color: var(--accent-color);">ç½‘ç»œé”™è¯¯: ' + error.message + '</p>';
            }
        }

        // æŒ‰åˆ†ç±»ç­›é€‰å¸–å­
        function filterByCategory(category) {
            currentCategory = category;

            // æ›´æ–°åˆ†ç±»æ ‡ç­¾çŠ¶æ€
            const tabs = document.querySelectorAll('.category-tab');
            tabs.forEach(tab => {
                if (tab.textContent.trim() === 'å…¨éƒ¨' && category === 'all') {
                    tab.classList.add('active');
                } else if (tab.textContent.trim() === getCategoryName(category) && category !== 'all') {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // ç­›é€‰å¸–å­
            let filteredPosts = allPosts;
            if (category === 'tech') { // ç²¾ååˆ†ç±»
                filteredPosts = allPosts.filter(post => post.is_featured === 1);
            } else if (category !== 'all') {
                filteredPosts = allPosts.filter(post => post.category === category);
            }

            displayPosts(filteredPosts);
        }

        // è·å–åˆ†ç±»ä¸­æ–‡å
        function getCategoryName(category) {
            const categoryMap = {
                'tech': 'ç²¾å',
                'life': 'æ”¶è—',
                'entertainment': 'çŒæ°´',
                'education': 'æ”»ç•¥',
                'other': 'å…¶ä»–'
            };
            return categoryMap[category] || 'å…¶ä»–';
        }

        // æ˜¾ç¤ºå¸–å­åˆ—è¡¨
        function displayPosts(posts) {
            const container = document.getElementById('postsContainer');
            if (!posts || posts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); padding: 20px; text-align: center;">æš‚æ— å¸–å­ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€ä¸ªå¸–å­å§ï¼</p>';
                return;
            }

            let html = '';
            posts.forEach(post => {
                const preview = post.content.length > 100 ?
                    post.content.substring(0, 100) + '...' : post.content;
                const time = new Date(post.created).toLocaleString();
                const categoryName = getCategoryName(post.category || 'other');

                html += '<div class="post-item">';
                html += '<div class="post-prefix"></div>'; // åœ¨æ¯ä¸ªå¸–å­å‰é¢æ·»åŠ æ ·å¼å…ƒç´ 
                html += '<div class="post-main">';
                html += '<a href="forum-post.html?id=' + post.id + '" class="post-title">' + post.title + '</a>';
                html += '<div class="post-content-preview">' + preview + '</div>';
                html += '<div class="post-meta">';
                html += '<span style="background-color: var(--secondary-color); padding: 2px 8px; border-radius: 3px; font-size: 12px;">' + categoryName + '</span>';
                html += '<span>ä½œè€…: ' + post.author + '</span>';
                html += '<span>æ—¶é—´: ' + time + '</span>';
                html += '<span>æµè§ˆ: ' + (post.view_count || 0) + '</span>';
                html += '<span>è¯„è®º: ' + (post.comment_count || 0) + '</span>';
                html += '<span>ç‚¹èµ: ' + (post.like_count || 0) + '</span>';
                // æ·»åŠ ç²¾åæŒ‰é’®
                if (checkAdmin()) {
                    html += '<button onclick="toggleFeatured(\'' + post.id + '\', ' + (post.is_featured ? 'true' : 'false') + ')" style="margin-left:10px; padding:2px 6px; font-size:12px;">' + 
                            (post.is_featured ? 'å–æ¶ˆç²¾å' : 'ç²¾å') + '</button>';
                }
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // å¯ä»¥ç§»é™¤viewPostå‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨ä½¿ç”¨ç›´æ¥é“¾æ¥

        // ç”¨äºä»å¸–å­è¯¦æƒ…é¡µåŒæ­¥æ›´æ–°è¯„è®ºå’Œç‚¹èµæ•°é‡
        window.updatePostCounts = function (postId, commentCount, likeCount) {
            // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
            const postIndex = allPosts.findIndex(post => post.id === postId);
            if (postIndex !== -1) {
                allPosts[postIndex].comment_count = commentCount;
                allPosts[postIndex].like_count = likeCount;
            }

            // æ›´æ–°UIæ˜¾ç¤º
            const postItems = document.querySelectorAll('.post-item');
            postItems.forEach(item => {
                const titleLink = item.querySelector('.post-title');
                if (titleLink && titleLink.href.includes('id=' + postId)) {
                    const metaSpans = item.querySelectorAll('.post-meta span');
                    if (metaSpans.length >= 5) { // æµè§ˆã€è¯„è®ºã€ç‚¹èµåœ¨ä½ç½®ä¸Šæ˜¯ç¬¬3ã€4ã€5ä¸ªspan
                        metaSpans[3].textContent = 'è¯„è®º: ' + commentCount;
                        metaSpans[4].textContent = 'ç‚¹èµ: ' + likeCount;
                    }
                }
            });
        };

        // æ˜¾ç¤ºåˆ›å»ºå¸–å­æ¨¡æ€æ¡†
        function showCreatePostModal() {
            document.getElementById('createPostModal').style.display = 'block';
        }

        // éšè—åˆ›å»ºå¸–å­æ¨¡æ€æ¡†
        function hideCreatePostModal() {
            document.getElementById('createPostModal').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            document.getElementById('postAuthor').value = '';
            document.getElementById('postCategory').value = 'tech';
            document.getElementById('postImages').value = '';
            document.getElementById('imagePreview').innerHTML = '';
        }

        // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
        document.getElementById('postImages').addEventListener('change', function (e) {
            const files = e.target.files;
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = '';

            if (files) {
                Array.from(files).forEach(file => {
                    if (file.size > 5 * 1024 * 1024) {
                        alert(file.name + ' æ–‡ä»¶å¤§å°è¶…è¿‡5MBï¼Œè¯·é€‰æ‹©æ›´å°çš„å›¾ç‰‡');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.width = '100px';
                        img.style.height = '100px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '3px';
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        // åˆ›å»ºå¸–å­ï¼ˆåŒ…å«å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼‰
        async function createPost() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const author = document.getElementById('postAuthor').value;
            const category = document.getElementById('postCategory').value;
            const images = document.getElementById('postImages').files;

            if (!title || !content || !author) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            try {
                // ç”±äºAPIå¯èƒ½ä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼Œæˆ‘ä»¬ä½¿ç”¨base64æ¨¡æ‹Ÿå›¾ç‰‡æ•°æ®
                const imageDataList = [];
                if (images && images.length > 0) {
                    // æ¨¡æ‹Ÿå›¾ç‰‡ä¸Šä¼ ï¼Œå®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨FormDataä¸Šä¼ æ–‡ä»¶
                    for (let i = 0; i < Math.min(images.length, 5); i++) { // é™åˆ¶æœ€å¤š5å¼ å›¾ç‰‡
                        const reader = new FileReader();
                        await new Promise(resolve => {
                            reader.onload = function () {
                                // åªå–base64çš„å‰100ä¸ªå­—ç¬¦ä½œä¸ºç¤ºä¾‹
                                imageDataList.push(reader.result.substring(0, 100) + '...');
                                resolve();
                            };
                            reader.readAsDataURL(images[i]);
                        });
                    }
                }

                const response = await fetch(API_BASE + '/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        author: author,
                        category: category,
                        images: imageDataList // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å›¾ç‰‡URLåˆ—è¡¨
                    })
                });

                const result = await response.json();
                if (result.errno === 0) {
                    alert('å¸–å­å‘è¡¨æˆåŠŸï¼');
                    hideCreatePostModal();
                    // é‡æ–°åŠ è½½å¸–å­åˆ—è¡¨
                    loadPosts();
                } else {
                    alert('å‘è¡¨å¤±è´¥: ' + result.errmsg);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function (event) {
            const modal = document.getElementById('createPostModal');
            if (event.target === modal) {
                hideCreatePostModal();
            }
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function setupThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');

            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸»é¢˜åå¥½ - é»˜è®¤ä½¿ç”¨æµ…è‰²æ¨¡å¼
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = 'ğŸŒ™';
            } else {
                themeToggle.textContent = 'â˜€ï¸';
            }

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');

                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('theme', 'dark');
                    themeToggle.textContent = 'ğŸŒ™';
                } else {
                    localStorage.setItem('theme', 'light');
                    themeToggle.textContent = 'â˜€ï¸';
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            setupThemeToggle();
            loadPosts();
        });

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        // éšè—ç™»å½•æ¨¡æ€æ¡†
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        // ç®¡ç†å‘˜ç™»å½•
        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (!password) return;

            try {
                const response = await fetch(API_BASE + '/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                const result = await response.json();

                if (result.errno === 0) {
                    localStorage.setItem('isAdmin', 'true');
                    alert('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                    document.getElementById('adminLogin').style.display = 'none';
                } else {
                    alert('å¯†ç é”™è¯¯: ' + result.errmsg);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        // ç‚¹å‡»èƒŒæ™¯é®ç½©å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('modalOverlay').addEventListener('click', hideLoginModal);
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
         function checkAdmin() {
             return localStorage.getItem('isAdmin') === 'true';
         }

         // åˆ‡æ¢å¸–å­ç²¾åçŠ¶æ€
         async function toggleFeatured(postId, isFeatured) {
             try {
                 const response = await fetch(API_BASE + '/posts/' + postId + '/featured', {
                     method: 'PUT',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ is_featured: !isFeatured })
                 });
                 const result = await response.json();

                 if (result.errno === 0) {
                     // æ›´æ–°æœ¬åœ°æ•°æ®
                     const post = allPosts.find(p => p.id === postId);
                     if (post) {
                         post.is_featured = !isFeatured;
                     }
                     // é‡æ–°æ¸²æŸ“å¸–å­åˆ—è¡¨
                     filterByCategory(currentCategory);
                     alert(isFeatured ? 'å·²å–æ¶ˆç²¾å' : 'å·²è®¾ä¸ºç²¾å');
                 } else {
                     alert('æ“ä½œå¤±è´¥: ' + result.errmsg);
                 }
             } catch (error) {
                 alert('ç½‘ç»œé”™è¯¯: ' + error.message);
             }
         }
    </script>

    <!-- ç®¡ç†å‘˜ç™»å½•æŒ‰é’® -->
    <div id="adminLoginButton" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
        <button onclick="showLoginModal()"
            style="padding: 6px 12px; background: #1E88E5; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">ç™»å½•</button>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† (é»˜è®¤éšè—) -->
    <div id="loginModal"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ddd; padding: 20px; border-radius: 5px; box-shadow: 0 2px 16px rgba(0,0,0,0.2); z-index: 1001; width: 250px;">
        <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 16px; text-align: center;">ç®¡ç†å‘˜ç™»å½•</h3>
        <div style="margin-bottom: 15px;">
            <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç "
                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px;">
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="hideLoginModal()"
                style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">å–æ¶ˆ</button>
            <button onclick="adminLogin()"
                style="padding: 8px 16px; background: #1E88E5; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">ç™»å½•</button>
        </div>
    </div>

    <!-- èƒŒæ™¯é®ç½© (é»˜è®¤éšè—) -->
    <div id="modalOverlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    </div>
</body>

</html>